<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | Verity</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0b;--card:#111113;--elevated:#18181b;--border:rgba(255,255,255,0.06);--text:#fafafa;--muted:#a3a3a3;--dim:#525252;--amber:#f59e0b;--amber-soft:rgba(245,158,11,0.12);--green:#10b981;--red:#ef4444}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        ::selection{background:rgba(245,158,11,0.3)}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .reset-container{width:100%;max-width:440px;animation:fadeIn .5s ease}
        
        .logo{display:flex;align-items:center;justify-content:center;gap:.6rem;text-decoration:none;color:var(--text);margin-bottom:2rem}
        .logo svg{width:40px;height:44px}
        .logo span{font-family:'Newsreader',Georgia,serif;font-size:1.8rem;font-weight:500}
        .logo .dot{color:var(--amber)}
        
        .reset-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;text-align:center}
        .reset-card h1{font-family:'Newsreader',Georgia,serif;font-size:1.8rem;font-weight:400;margin-bottom:.5rem}
        .reset-card p{color:var(--muted);margin-bottom:2rem;font-size:.95rem}
        
        .form-group{margin-bottom:1.25rem;text-align:left}
        .form-label{display:block;font-size:.85rem;font-weight:500;margin-bottom:.5rem;color:var(--muted)}
        .form-input{width:100%;padding:1rem 1.25rem;background:var(--elevated);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem;transition:all .2s}
        .form-input:focus{outline:none;border-color:var(--amber);box-shadow:0 0 0 3px rgba(245,158,11,0.1)}
        .form-input::placeholder{color:var(--dim)}
        
        .password-requirements{background:var(--elevated);border-radius:10px;padding:1rem;margin-bottom:1.5rem;text-align:left}
        .password-requirements h4{font-size:.8rem;font-weight:600;color:var(--muted);margin-bottom:.5rem}
        .requirement{display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:var(--dim);margin:.25rem 0}
        .requirement.met{color:var(--green)}
        .requirement svg{width:14px;height:14px}
        
        .btn-submit{width:100%;padding:1rem;background:linear-gradient(135deg,var(--amber),#d97706);border:none;border-radius:12px;color:#000;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}
        .btn-submit:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(245,158,11,0.3)}
        .btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .btn-submit .spinner{animation:spin 1s linear infinite}
        
        .back-link{display:inline-flex;align-items:center;gap:.5rem;margin-top:1.5rem;color:var(--muted);text-decoration:none;font-size:.9rem}
        .back-link:hover{color:var(--amber)}
        
        .success-message,.error-message{padding:1rem;border-radius:12px;margin-bottom:1.5rem;display:none}
        .success-message{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:var(--green)}
        .error-message{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red)}
        .success-message.show,.error-message.show{display:block}
    </style>
</head>
<body>
    <div class="reset-container">
        <a href="index.html" class="logo">
            <svg viewBox="0 0 100 120" fill="none"><defs><linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#fbbf24"/></linearGradient></defs><path fill="none" stroke="url(#lg)" stroke-width="6" d="M50 10 L85 30 L85 70 C85 95 50 105 50 105 C50 105 15 95 15 70 L15 30 Z"/><polyline fill="none" stroke="url(#lg)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" points="35,60 45,72 65,48"/></svg>
            <span>verity<span class="dot">.</span></span>
        </a>
        
        <div class="reset-card">
            <h1>Reset your password</h1>
            <p>Enter your new password below</p>
            
            <div class="success-message" id="successMessage">
                <strong>Password updated!</strong> You can now sign in with your new password.
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <form id="resetForm">
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Enter new password" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm new password" required>
                </div>
                
                <div class="password-requirements" id="requirements">
                    <h4>Password Requirements</h4>
                    <div class="requirement" data-req="length">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                        <span>At least 8 characters</span>
                    </div>
                    <div class="requirement" data-req="uppercase">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                        <span>One uppercase letter</span>
                    </div>
                    <div class="requirement" data-req="lowercase">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                        <span>One lowercase letter</span>
                    </div>
                    <div class="requirement" data-req="number">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                        <span>One number</span>
                    </div>
                </div>
                
                <button type="submit" class="btn-submit" id="submitBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Reset Password
                </button>
            </form>
            
            <a href="auth.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back to Sign In
            </a>
        </div>
    </div>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase-client.js?v=2.0.1"></script>
    
    <script>
        const form = document.getElementById('resetForm');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Password validation
        function validatePassword(password) {
            return {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password)
            };
        }
        
        function updateRequirements(password) {
            const checks = validatePassword(password);
            const checkIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            const circleIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
            
            Object.keys(checks).forEach(req => {
                const el = document.querySelector(`[data-req="${req}"]`);
                if (el) {
                    el.classList.toggle('met', checks[req]);
                    el.querySelector('svg').outerHTML = checks[req] ? checkIcon : circleIcon;
                }
            });
            
            return Object.values(checks).every(v => v);
        }
        
        newPassword.addEventListener('input', () => {
            updateRequirements(newPassword.value);
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate passwords match
            if (newPassword.value !== confirmPassword.value) {
                errorMessage.textContent = 'Passwords do not match';
                errorMessage.classList.add('show');
                return;
            }
            
            // Validate password strength
            if (!updateRequirements(newPassword.value)) {
                errorMessage.textContent = 'Password does not meet requirements';
                errorMessage.classList.add('show');
                return;
            }
            
            // Show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg> Updating...';
            errorMessage.classList.remove('show');
            
            try {
                // Update password via Supabase
                const client = window.VeritySupabase?.client || window.supabaseClient;
                if (!client) {
                    throw new Error('Authentication service not available. Please refresh the page.');
                }
                const { data, error } = await client.auth.updateUser({
                    password: newPassword.value
                });
                
                if (error) throw error;
                
                // Show success
                successMessage.classList.add('show');
                form.style.display = 'none';
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'auth.html?reset=success';
                }, 2000);
                
            } catch (error) {
                errorMessage.textContent = error.message || 'Failed to reset password';
                errorMessage.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Reset Password';
            }
        });
        
        // Check for access token in URL (from email link)
        const hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
            // Supabase handles this automatically
            console.log('Password reset token found');
        }
    </script>
</body>
</html>
