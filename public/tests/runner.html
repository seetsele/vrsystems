<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Run Tests â€” Verity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="tests.css">
  <style>
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    button.run{background:#10b981;color:#000;padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfefff;padding:8px 10px;border-radius:8px;cursor:pointer}
    .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,0.06);border-top-color:#7dd3fc;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .summary{margin-top:12px;padding:14px;background:linear-gradient(90deg,#07101a,#06111a);border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .test-row{border-bottom:1px solid rgba(255,255,255,0.03);padding:10px 0;display:flex;flex-direction:column}
    .test-meta{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .test-meta .left{display:flex;gap:12px;align-items:center}
    .badge{font-family:JetBrains Mono,monospace;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,0.02);font-size:0.85rem}
    .outcome.passed{color:#10b981}
    .outcome.failed{color:#ef4444}
    .outcome.skipped{color:#f59e0b}
    pre.console{background:#02060a;color:#cfefff;padding:12px;border-radius:6px;overflow:auto;white-space:pre-wrap}
    .controls{display:flex;gap:8px;align-items:center}
    input.filter{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
    .collapsed{display:none}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;margin-top:10px}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#10b981,#7dd3fc);width:0%}
    a.src-link{color:#7dd3fc;text-decoration:none}
    .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Browser Test Runner</h1>
    <p>Run repository tests from the browser. This executes pytest on the host and returns a structured report.</p>

    <div class="top-row">
      <div style="display:flex;gap:8px;align-items:center">
        <a href="history.html" style="margin-right:8px;align-self:center;color:#7dd3fc">History</a>
        <a href="webhooks.html" style="margin-right:8px;align-self:center;color:#7dd3fc">Webhooks</a>
        <select id="target">
          <option value="tests">tests/ (default)</option>
          <option value="python-tools/tests">python-tools/tests</option>
          <option value="all">all (may be slow)</option>
        </select>
        <select id="type-filter" style="margin-left:6px">
          <option value="all">All types</option>
        </select>
        <label style="margin-left:8px"><input type="checkbox" id="redact" checked /> Redact PII</label>
        <input id="api-key" placeholder="API key (optional)" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8" />
        <button id="run-selected" class="secondary">Run Selected</button>
        <input class="filter" id="filter" placeholder="Filter tests (name or status)" />
        <button id="run" class="run">Run Tests</button>
        <button id="download" class="secondary">Download JSON</button>
        <button id="purge-logs" class="secondary">Purge Logs</button>
      </div>
      <div class="controls"><div id="status"></div></div>
    </div>

    <div class="progress" aria-hidden="true"><i id="progress-bar"></i></div>

    <div id="report"></div>
    <div id="test-list" style="margin-top:12px"></div>
      <h3 style="margin-top:12px">Live Runner Logs</h3>
      <pre id="live-logs" class="console" style="height:160px;overflow:auto">(no logs yet)</pre>
  </div>

  <script>
    const runBtn = document.getElementById('run');
    const status = document.getElementById('status');
    const report = document.getElementById('report');
    const target = document.getElementById('target');

    let lastResults = null;
    async function runTests(){
      report.innerHTML = '';
      status.innerHTML = '<span class="spinner"></span> Running...';
      startLogPoll();
      runBtn.disabled = true;
      document.getElementById('progress-bar').style.width = '5%';
      try{
        const typeSel = document.getElementById('type-filter');
        const typeVal = typeSel ? typeSel.value : 'all';
        const payload = {target: target.value};
        if(typeVal && typeVal !== 'all') payload.marker = typeVal;
        const redactCheck = document.getElementById('redact');
        payload.redact = redactCheck ? redactCheck.checked : true;
        const apiKeyEl = document.getElementById('api-key');
        const headers = {'Content-Type':'application/json'};
        if(apiKeyEl && apiKeyEl.value.trim()) headers['X-API-KEY'] = apiKeyEl.value.trim();
        const res = await fetch('http://127.0.0.1:8010/run-tests', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error('Server error: '+txt);
        }
        const json = await res.json();
        lastResults = json;
        document.getElementById('progress-bar').style.width = '100%';
          renderReport(json);
          // fetch logs one last time
          fetchLogsOnce();
      }catch(err){
        report.innerHTML = '<div class="summary">Error: '+err.message+'</div>';
      }finally{
        status.innerHTML = '';
        runBtn.disabled = false;
        stopLogPoll();
        setTimeout(()=>{document.getElementById('progress-bar').style.width='0%';},800);
      }

        // log streaming: prefer EventSource (SSE), fallback to polling
    let _logPoll = null;
    let _es = null;
    function startLogPoll(){
      const el = document.getElementById('live-logs');
      // try EventSource
      try{
        if(typeof EventSource !== 'undefined'){
          const apiKeyEl = document.getElementById('api-key');
          let esUrl = 'http://127.0.0.1:8010/stream-logs';
          if(apiKeyEl && apiKeyEl.value.trim()) esUrl += '?key=' + encodeURIComponent(apiKeyEl.value.trim());
          _es = new EventSource(esUrl);
          _es.onmessage = (ev)=>{
            try{
              const payload = JSON.parse(ev.data||'{}');
              // payload may be object with event/payload or direct payload
              const obj = payload.payload ? payload.payload : payload;
              el.textContent = (obj && obj.parsed) ? JSON.stringify(obj, null, 2) : JSON.stringify(obj, null, 2);
              el.scrollTop = el.scrollHeight;
            }catch(e){}
          };
          _es.onerror = ()=>{
            try{ _es.close(); _es = null; }catch(e){}
          };
          return;
        }
      }catch(e){ /* ignore */ }
      // fallback to polling
      if(_logPoll) return;
      _logPoll = setInterval(async ()=>{
        try{
          const apiKeyEl = document.getElementById('api-key');
          let logsUrl = 'http://127.0.0.1:8010/logs';
          if(apiKeyEl && apiKeyEl.value.trim()) logsUrl += '?key=' + encodeURIComponent(apiKeyEl.value.trim());
          const r = await fetch(logsUrl, {headers: apiKeyEl && apiKeyEl.value.trim() ? {'X-API-KEY': apiKeyEl.value.trim()} : undefined});
          if(!r.ok) return;
          const j = await r.json();
          if(j && j.log){ el.textContent = j.log; el.scrollTop = el.scrollHeight; }
        }catch(e){ /* ignore */ }
      }, 1000);
    }
    function stopLogPoll(){ if(_logPoll){ clearInterval(_logPoll); _logPoll = null } if(_es){ try{ _es.close(); }catch(e){} _es = null } }
    async function fetchLogsOnce(){ try{ const apiKeyEl = document.getElementById('api-key'); let logsUrl = 'http://127.0.0.1:8010/logs'; if(apiKeyEl && apiKeyEl.value.trim()) logsUrl += '?key=' + encodeURIComponent(apiKeyEl.value.trim()); const r = await fetch(logsUrl, {headers: apiKeyEl && apiKeyEl.value.trim() ? {'X-API-KEY': apiKeyEl.value.trim()} : undefined}); if(r.ok){ const j=await r.json(); document.getElementById('live-logs').textContent = j.log||'' } }catch(e){} }
    }

    // load tests.json to render selectable test items
    async function loadTestIndex(){
      try{
        const resp = await fetch('./tests.json');
        if(!resp.ok) return;
        const data = await resp.json();
        const container = document.getElementById('test-list');
        if(!data || !data.length) return;
        let html = '<h2>Available Tests</h2><div style="max-height:240px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">';
        data.forEach((f, idx)=>{
          const file = f.path;
          const base = file.replace(/\//g,'_');
          html += `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">`;
          html += `<div style="font-weight:700">${file}</div>`;
          if(Array.isArray(f.functions) && f.functions.length){
            html += '<div style="margin-top:6px">';
            f.functions.forEach(fn=>{
              const nodeid = `${file}::${fn}`;
              html += `<label style="display:block"><input type="checkbox" data-nodeid="${nodeid}" /> <span style="font-family:JetBrains Mono,monospace">${fn}</span></label>`;
            });
            html += '</div>';
          }
          if(Array.isArray(f.classes) && f.classes.length){
            html += '<div style="margin-top:6px;font-size:0.9rem;color:var(--muted)">Classes: '+f.classes.join(', ')+'</div>';
          }
          if(Array.isArray(f.markers) && f.markers.length){
            html += '<div style="margin-top:6px;color:var(--muted)">Markers: '+f.markers.join(', ')+'</div>';
          }
          html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
        // populate type filter with discovered types
        try{
          const types = new Set();
          data.forEach(f=>{ if(Array.isArray(f.types)){ f.types.forEach(t=>types.add(t)) } });
          const sel = document.getElementById('type-filter');
          if(sel){
            // remove existing non-default options
            Array.from(sel.querySelectorAll('option')).forEach(o=>{ if(o.value!=='all') o.remove() });
            Array.from(types).sort().forEach(t=>{
              const opt = document.createElement('option'); opt.value = t; opt.textContent = t; sel.appendChild(opt);
            });
          }
        }catch(e){ console.warn('type filter populate failed', e) }
      }catch(err){
        console.warn('Failed to load tests.json', err);
      }
    }

    async function runSelected(){
      // collect checked nodeids
      const checks = Array.from(document.querySelectorAll('#test-list input[type=checkbox]:checked'));
      if(!checks.length) return alert('No tests selected');
      const items = checks.map(c=>c.getAttribute('data-nodeid'));
      report.innerHTML = '';
      status.innerHTML = '<span class="spinner"></span> Running selected...';
      startLogPoll();
      runBtn.disabled = true;
      try{
        const apiKeyEl = document.getElementById('api-key');
        const headers = {'Content-Type':'application/json'};
        if(apiKeyEl && apiKeyEl.value.trim()) headers['X-API-KEY'] = apiKeyEl.value.trim();
        const redactCheck = document.getElementById('redact');
        const res = await fetch('http://127.0.0.1:8010/run-tests', {
          method: 'POST', headers: headers, body: JSON.stringify({items: items, redact: redactCheck ? redactCheck.checked : true})
        });
        if(!res.ok){ const t = await res.text(); throw new Error(t) }
        const json = await res.json();
        lastResults = json;
        document.getElementById('progress-bar').style.width = '100%';
        renderReport(json);
      }catch(err){ report.innerHTML = '<div class="summary">Error: '+err.message+'</div>'; }
      finally{ status.innerHTML = ''; runBtn.disabled = false; stopLogPoll(); setTimeout(()=>{document.getElementById('progress-bar').style.width='0%';},800); }
    }

    document.getElementById('run-selected').addEventListener('click', runSelected);
    loadTestIndex();

    function renderReport(r){
      const parsed = r.parsed || {};
      const sum = parsed.summary || {};
      let html = `<div class="summary"><strong>Exit code:</strong> ${r.exit_code} &nbsp; <strong>Total:</strong> ${sum.total||0} &nbsp; <span class="outcome passed">Passed: ${sum.passed||0}</span> &nbsp; <span class="outcome failed">Failed: ${sum.failed||0}</span> &nbsp; <span class="outcome skipped">Skipped: ${sum.skipped||0}</span> &nbsp; <strong>Time:</strong> ${sum.time||0}s</div>`;

      if(Array.isArray(parsed.tests)){
        html += '<div style="margin-top:12px">';
        parsed.tests.forEach((t, idx) => {
          const shortName = t.name.replace(/\(.+\)$/, '');
          html += `<div class="test-row" data-name="${escapeHtml(t.name)}" data-outcome="${t.outcome}">`;
          html += `<div class="test-meta"><div class="left"><span class="badge">${idx+1}</span><strong>${escapeHtml(shortName)}</strong> <small>(${escapeHtml(t.classname||'' )})</small></div><div><span class="outcome ${t.outcome}">${t.outcome}</span> <button class="secondary" data-idx="${idx}">Toggle</button></div></div>`;
          html += `<div class="collapsed" id="detail-${idx}">`;
          if(t.message){
            html += `<pre style="margin-top:6px;background:#0b1220;padding:8px;border-radius:6px">${escapeHtml(t.message)}</pre>`;
          } else {
            html += `<div style="margin-top:6px;color:var(--muted)">No message</div>`;
          }
          html += `</div>`;
          html += `</div>`;
        });
        html += '</div>';
      }

      html += `<h3 style="margin-top:12px">Console Output</h3><pre class="console">${escapeHtml(r.stdout||'')}</pre>`;
      if(r.stderr) html += `<h4>Stderr</h4><pre class="console">${escapeHtml(r.stderr)}</pre>`;

      report.innerHTML = html;
      // wire toggle buttons and filtering
      document.querySelectorAll('button.secondary[data-idx]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-idx');
          const el = document.getElementById('detail-'+id);
          if(el) el.classList.toggle('collapsed');
        });
      });
      document.getElementById('filter').addEventListener('input', ()=>{
        const v = document.getElementById('filter').value.toLowerCase().trim();
        document.querySelectorAll('.test-row').forEach(row=>{
          const name = (row.getAttribute('data-name')||'').toLowerCase();
          const out = (row.getAttribute('data-outcome')||'').toLowerCase();
          row.style.display = (name.includes(v) || out.includes(v)) ? '' : 'none';
        });
      });
      document.getElementById('download').addEventListener('click', ()=>{
        if(!lastResults) return alert('No results to download');
        const blob = new Blob([JSON.stringify(lastResults, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'test-results.json'; a.click(); URL.revokeObjectURL(url);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    runBtn.addEventListener('click', runTests);
    document.getElementById('purge-logs').addEventListener('click', async ()=>{
      if(!confirm('Purge runner logs? This cannot be undone.')) return;
      const apiKeyEl = document.getElementById('api-key');
      try{
        const headers = {};
        if(apiKeyEl && apiKeyEl.value.trim()) headers['X-API-KEY'] = apiKeyEl.value.trim();
        const r = await fetch('http://127.0.0.1:8010/purge-logs', {method:'POST', headers});
        if(!r.ok) throw new Error(await r.text());
        document.getElementById('live-logs').textContent = '(logs purged)';
      }catch(e){ alert('Failed to purge logs: '+e.message) }
    });
  </script>
</body>
</html>
