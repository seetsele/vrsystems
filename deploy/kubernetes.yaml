# Verity Systems - Kubernetes Deployment
# ======================================
# Deploy to any Kubernetes cluster (GKE, EKS, AKS, etc.)

---
apiVersion: v1
kind: Namespace
metadata:
  name: verity
  labels:
    name: verity

---
apiVersion: v1
kind: Secret
metadata:
  name: verity-secrets
  namespace: verity
type: Opaque
stringData:
  secret-key: "your-production-secret-key-here"
  api-keys: "key1,key2,key3"
  groq-api-key: "your-groq-key"
  google-ai-key: "your-google-ai-key"
  perplexity-key: "your-perplexity-key"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: verity-config
  namespace: verity
data:
  ENVIRONMENT: "production"
  PORT: "8000"
  HOST: "0.0.0.0"
  RATE_LIMIT_REQUESTS: "100"
  RATE_LIMIT_WINDOW: "60"
  LOG_LEVEL: "INFO"
  CORS_ORIGINS: "https://verity.systems,https://www.verity.systems"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: verity-api
  namespace: verity
  labels:
    app: verity-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: verity-api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app: verity-api
    spec:
      containers:
        - name: verity-api
          image: verity-api:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              protocol: TCP
          envFrom:
            - configMapRef:
                name: verity-config
          env:
            - name: VERITY_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: verity-secrets
                  key: secret-key
            - name: API_KEYS
              valueFrom:
                secretKeyRef:
                  name: verity-secrets
                  key: api-keys
            - name: GROQ_API_KEY
              valueFrom:
                secretKeyRef:
                  name: verity-secrets
                  key: groq-api-key
            - name: GOOGLE_AI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: verity-secrets
                  key: google-ai-key
            - name: REDIS_URL
              value: "redis://verity-redis:6379"
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: verity-api
                topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: verity-api
  namespace: verity
  labels:
    app: verity-api
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app: verity-api

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: verity-redis
  namespace: verity
spec:
  replicas: 1
  selector:
    matchLabels:
      app: verity-redis
  template:
    metadata:
      labels:
        app: verity-redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
          command:
            - redis-server
            - --maxmemory
            - "256mb"
            - --maxmemory-policy
            - allkeys-lru
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"

---
apiVersion: v1
kind: Service
metadata:
  name: verity-redis
  namespace: verity
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app: verity-redis

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: verity-ingress
  namespace: verity
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
    - hosts:
        - api.verity.systems
      secretName: verity-api-tls
  rules:
    - host: api.verity.systems
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: verity-api
                port:
                  number: 80

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: verity-api-hpa
  namespace: verity
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: verity-api
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: verity-api-pdb
  namespace: verity
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: verity-api
