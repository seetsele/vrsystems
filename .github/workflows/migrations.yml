name: DB Migrations and Smoke Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (e.g. staging or production)'
        required: true
        default: 'staging'

jobs:
  backup_and_migrate:
    name: Backup and Migrate (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      actions: read
      statuses: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system deps (postgres client)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Install Python deps
        run: python -m pip install --upgrade pip && python -m pip install -r python-tools/requirements.txt

      - name: Create DB backup (artifact)
        if: ${{ secrets.DATABASE_URL != '' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Creating DB dump to artifact..."
          pg_dump $DATABASE_URL -Fc -f verity_backup.dump

      - name: Upload DB backup artifact
        if: ${{ secrets.DATABASE_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: verity-backup-${{ github.run_id }}
          path: verity_backup.dump

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python python-tools/run_migrations.py

      - name: Run smoke / integration tests (best-effort)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RUN_INTEGRATION_TESTS: '1'
        run: |
          # Run focused integration test; don't fail the workflow here so logs are available.
          python -m pytest python-tools/tests/test_stripe_webhook_integration.py -q || true
