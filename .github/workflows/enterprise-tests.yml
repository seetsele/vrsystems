name: Enterprise Test Runner

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *' # daily at 02:00 UTC
  workflow_dispatch:
    inputs:
      strict:
        description: 'Run in strict mode (fail on any failing endpoint)'
        required: false
        default: 'false'
      update_baselines:
        description: 'Update Playwright baseline screenshots'
        required: false
        default: 'false'

env:
  TEST_URL: ${{ secrets.TEST_URL }}

jobs:
  run-api:
    runs-on: ubuntu-latest
    env:
      TEST_URL: ${{ secrets.TEST_URL }}
      STRICT_TESTS: ${{ github.event.inputs.strict || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest jsonschema

      - name: Run artifact-first API runner
        run: |
          python tests/enterprise/run_api_full.py

      - name: Run Fireworks multi-probe
        run: |
          python tests/enterprise/check_fireworks.py || true

      - name: Quota monitor (fail when low)
        env:
          FW_QUOTA_THRESHOLD: ${{ secrets.FW_QUOTA_THRESHOLD || '100' }}
        run: |
          python tests/enterprise/quota_monitor.py || true

      - name: Run pytest (artifact consumer)
        run: |
          python -m pytest tests/enterprise/test_api_full.py -q || true

      - name: Upload test-vault artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-vault
          path: test-vault/

  playwright:
    needs: run-api
    runs-on: ubuntu-latest
    if: ${{ secrets.TEST_URL != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node deps and Playwright
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Run Playwright UI flows + visual snapshots
        env:
          TEST_URL: ${{ secrets.TEST_URL }}
        run: |
          npx playwright test tests/visual/ui-flows.spec.ts --project=chromium --reporter=list || true
          npx playwright test tests/visual/test-visual.spec.ts --project=chromium --reporter=list || true
          echo "Ensure screenshots present:" && ls -la playwright-report/screenshots || true
      - name: Optionally generate baseline updates
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        run: |
          python tests/visual/update_baselines.py

      - name: Upload baseline updates
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: baseline-updates
          path: baseline-updates-*.zip

      - name: Upload Playwright artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
      - name: Package artifacts
        run: |
          python tests/enterprise/package_artifacts.py

      - name: Upload artifacts zip
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-artifacts
          path: artifacts-*.zip

  strict-gated:
    needs: [run-api]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.strict == 'true' }}
    env:
      TEST_URL: ${{ secrets.TEST_URL }}
      STRICT_TESTS: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest

      - name: Invoke runner (strict)
        run: |
          python tests/enterprise/run_api_full.py

      - name: Run pytest (strict)
        run: |
          python -m pytest tests/enterprise/test_api_full.py -q

